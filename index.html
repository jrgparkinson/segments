<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- <meta name="description" content="App to convert images to GPS traces"> -->
    <meta name="author" content="Cowley Club">
    <!-- <meta name="google-site-verification" content="XgQIxzadoD1l96u2A3av9GPyRdSBQRkXLOQr019BDD4" /> -->
    <title>Track Splits</title>

    <!-- <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBnY4r8Huth48Tx-7rN565bmajelV0zqoU&callback=initMap&libraries=&v=weekly">
    </script> -->

    <!-- Bootstrap core CSS -->
    <!-- CSS only -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">


    <!-- JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>

    <!-- Custom styles for this template -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>

    <style>
        body {
            padding: 0;
            margin: 0;
        }
        
        html,
        body,
        #map {
            height: 100%;
            width: 100%;
        }
        
        #controls {
            position: fixed;
            top: 0;
            right: 0;
            /* width: 200px; */
            z-index: 1000;
            padding: 10px;
            background-color: white;
        }
    </style>

</head>

<body>


    <div id="map"></div>

    <div id="controls">
        <div class="mb-3 row">
            <label for="inputPassword" class="col-sm-4 col-form-label">Region</label>
            <div class="col-sm-8">
                <input type="text" class="form-control" id="region" value="Oxford" readonly onchange="updateMap()">
            </div>
        </div>

        <div class="mb-3 row">
            <label for="inputPassword" class="col-sm-4 col-form-label">Athlete</label>
            <div class="col-sm-8">
                <input type="text" class="form-control" id="athlete" onkeyup="updateMap()">
            </div>
        </div>

        <div class="mb-3 row">
            <label for="inputPassword" class="col-sm-4 col-form-label">Colour scale</label>
            <div class="col-sm-8">
                <select class="form-select" aria-label="Default select example" id="colourScale" onchange="updateMap()">
                    <option selected value="distance_gap">Equivalent 1k flat pace</option>
                    <option value="fastest_pace">Pace</option>
                    <option value="grade_adjusted_pace">Grade adjusted pace</option>
                  </select>
            </div>
        </div>


    </div>


    <script type="text/javascript">
        var map = null;

        // Options that should eventually be configurable
        var region = "oxford";
        var highlightAthlete = "Jamie Parkinson";
        var colourCoding = "fastest_pace";
        colourCoding = "grade_adjusted_pace";
        colourCoding = "distance_gap";
        var paceRange = [0, 10.0]; // min/k
        var lengthRange = [0, 100]; // km
        var climbRange = [0, 1000]; // metres
        var flatKmPaceRange = [0, 10]; // min/k

        function updateMap() {
            highlightAthlete = $("#athlete").val();
            colourCoding = $("#colourScale option:selected").val();
            region = $("#region").val().toLowerCase();

            console.log(highlightAthlete);
            console.log(colourCoding);
            console.log(region);

            /* delete method */
            $(".leaflet-marker-icon").remove();
            $(".leaflet-popup").remove();
            $(".leaflet-pane.leaflet-shadow-pane").remove();
            $('.leaflet-interactive').remove();

            populateMap();

        }

        function populateMap() {
            $.getJSON(`data/${region}/regions.json`, function(regions) {

                for (i = 0; i < regions.length; i++) {
                    var region = regions[i];

                    var opts = {
                        color: "red",
                        weight: 1,
                        fill: false,
                    };

                    L.rectangle(region.bounds, opts).addTo(map);
                }

            });

            $.getJSON(`data/${region}/segments.json`, function(segments) {

                // Compute diagnostics
                for (i = 0; i < segments.length; i++) {
                    var seg = segments[i];

                    seg.url = `https://www.strava.com/segments/${seg.id}`;

                    var seconds = 0;
                    if (seg.fastest_time.match(/\d+s/)) {
                        seconds = Number(seg.fastest_time.substr(0, seg.fastest_time.length - 1));
                    } else if (seg.fastest_time.match(/\d+:\d+/)) {
                        var array = seg.fastest_time.split(":");
                        seconds = (Number(array[0]) * 60) + Number(array[1]);
                    } else if (seg.fastest_time.match(/\d+:\d+:\d+/)) {
                        var array = seg.fastest_time.split(":");
                        seconds = (parseInt(array[0], 10) * 60 * 60) + (parseInt(array[1], 10) * 60) + parseInt(array[2], 10);
                    }

                    seg.fastest_pace = (seconds / 60) / (seg.distance / 1000);

                    var climb_per_km = seg.climb / (seg.distance / 1000);
                    // GAP: - 1 minute for 100 metres
                    seg.grade_adjusted_pace = seg.fastest_pace - climb_per_km / 100;

                    // Adjusted for 1k
                    // for every 100m under 1k, add 5 seconds/km
                    // for every 100m above 1k, subtract 1 seconds/km
                    // e.g. 800 in 2:00 (2:24/km)
                    //    = 1k in 2:34  (2:34/km)
                    //    = 3k in 8:42  (2:54/km)
                    var secondsPerHundred = 5;
                    if (seg.distance > 1000) {
                        secondsPerHundred = 1;
                    }
                    seg.distance_gap = seg.grade_adjusted_pace + (secondsPerHundred / 60) * (1 - seg.distance / 1000);
                }

                var colourCodingScale = [
                    Math.min.apply(Math, segments.map(function(segment) {
                        return segment[colourCoding];
                    })),
                    Math.max.apply(Math, segments.map(function(segment) {
                        return segment[colourCoding];
                    }))
                ];

                console.log(`Min/max pace: ${colourCodingScale[0]}, ${colourCodingScale[1]}`);
                for (i = 0; i < segments.length; i++) {
                    var seg = segments[i];

                    // console.log(seg);

                    seg.colour = val2color(seg[colourCoding], colourCodingScale);

                    // TODO: Compute color

                    var popupText = "<a href='" + seg.url + "'>" + seg.name + "</a>, distance: " + seg.distance + "m, <br> min/k: " + Number(seg.fastest_pace).toFixed(2) + " GAP: " + Number(seg.grade_adjusted_pace).toFixed(2);
                    popupText += " 1km flat equivalent pace: " + Number(seg.distance_gap).toFixed(2);

                    if (highlightAthlete != null && seg.fastest_athlete == highlightAthlete) {
                        L.marker(seg.start_latlng, {
                                color: seg.colour,
                                weight: 1
                            })
                            .bindPopup(popupText, {
                                sticky: true
                            }).openPopup()
                            .addTo(map);
                    } else {
                        L.circleMarker(seg.start_latlng, {
                                color: seg.colour,
                                weight: 1
                            })
                            .bindPopup(popupText, {
                                sticky: true
                            }).openPopup()
                            .addTo(map);
                    }

                }

            });
        }
        $(document).ready(function() {

            map = L.map('map').setView([51.753788, -1.247394], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            populateMap();

            L.control.scale().addTo(map);

        });

        function val2color(val, scale) {
            var perc = 100 - 100 * (val - scale[0]) / (scale[1] - scale[0]);
            var r, g, b = 0;
            if (perc < 50) {
                r = 255;
                g = Math.round(5.1 * perc);
            } else {
                g = 255;
                r = Math.round(510 - 5.10 * perc);
            }
            var h = r * 0x10000 + g * 0x100 + b * 0x1;
            return '#' + ('000000' + h.toString(16)).slice(-6);
        }
    </script>
</body>

</html>